<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>services/EmailMessage.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EmailAccountMiner.html">EmailAccountMiner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#getTree">getTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#getTreeByFolder">getTreeByFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#getTreeWithTotalPerFolder">getTreeWithTotalPerFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#mine">mine</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#mineBatch">mineBatch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#mineFolder">mineFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#mineMessages">mineMessages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailAccountMiner.html#sendBatch">sendBatch</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EmailMessage.html">EmailMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#extractEmailObjectsFromBody">extractEmailObjectsFromBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#extractEmailObjectsFromHeader">extractEmailObjectsFromHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getDate">getDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getEmailsObjectsFromBody">getEmailsObjectsFromBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getEmailsObjectsFromHeader">getEmailsObjectsFromHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getMessageId">getMessageId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getMessagingFieldsOnly">getMessagingFieldsOnly</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#getOtherMetaDataFields">getOtherMetaDataFields</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#isInConversation">isInConversation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#isNewsletter">isNewsletter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailMessage.html#isTransactional">isTransactional</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EmailServer.html">EmailServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailServer.html#connecte">connecte</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailServer.html#initConnection">initConnection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="EmailServer.html#isApiConnection">isApiConnection</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addChildrenTotalForParentFiles">addChildrenTotalForParentFiles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addPathPerFolder">addPathPerFolder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkDNS">checkDNS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkDomainIsOk">checkDomainIsOk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#compareDates">compareDates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createImapInfo">createImapInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createReadableTreeObjectFromImapTree">createReadableTreeObjectFromImapTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EqualPartsForSocket">EqualPartsForSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#extractNameAndEmail">extractNameAndEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#extractNameAndEmailFromBody">extractNameAndEmailFromBody</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateXOauthToken">generateXOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getBoxesAll">getBoxesAll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getBoxesAndFolders">getBoxesAndFolders</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEmails">getEmails</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPath">getPath</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hashEmail">hashEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IsNotNoReply">IsNotNoReply</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loginToAccount">loginToAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#refreshAccessToken">refreshAccessToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SignUpWithGoogle">SignUpWithGoogle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortDatabase">sortDatabase</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">services/EmailMessage.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const regExHelpers = require("../utils/regexpUtils");
const dateHelpers = require("../utils/dateHelpers");
const dataStructureHelpers = require("../utils/dataStructureHelpers");
const models = require("../models");
const { emailsRaw } = require("../models");
const NEWSLETTER_HEADER_FIELDS = process.env.NEWSLETTER;
const TRANSACTIONAL_HEADER_FIELDS = process.env.TRANSACTIONAL;
const CAMPAIGN_HEADER_FIELDS = process.env.CAMPAIGN;
const FIELDS = ["to", "from", "cc", "bcc", "reply-to"];

class EmailMessage {
  /**
   * The constructor function is a function that is called when a new object is created.
   * @param sequentialId - The sequential id of the message.
   * @param header - This is a JSON object that contains the header information for the message.
   * @param body - The body of the message.
   */
  constructor(sequentialId, size, header, body, user, redisClient) {
    this.sequentialId = sequentialId;
    this.size = size;
    this.header = header || {};
    this.body = body || {};
    this.user = user;
    this.redisClient = redisClient;
  }

  async createMessage() {
    await models.Messages.create({
      message_id: this.getMessageId(),
      isNewsletter: this.isNewsletter(),
      isTransactional: this.isTransactional(),
      isInConversation: this.isInConversation(),
    });
    await this.redisClient.sAdd("messages", this.getMessageId());
  }

  /**
   * If the header contains any of the fields in the NEWSLETTER_HEADER_FIELDS array, then return true
   * @returns True or False
   */
  isNewsletter() {
    return Object.keys(this.header).some((headerField) => {
      return NEWSLETTER_HEADER_FIELDS.includes(headerField.toLowerCase());
    });
  }
  isEmailConnection() {}
  /**
   * It returns true if the email is transactional, and false if it's not
   * @returns A boolean value.
   */
  isTransactional() {
    return Object.keys(this.header).some((headerField) => {
      return TRANSACTIONAL_HEADER_FIELDS.includes(headerField.toLowerCase());
    });
  }
  /**
   * If the header object has a key called "references", then return 1, otherwise return 0
   * @returns The function isInConversation() is returning a boolean value.
   */
  isInConversation() {
    if (Object.keys(this.header).includes("references")) {
      return 1;
    } else {
      return 0;
    }
  }
  getEmailType() {
    const type = [];
    if (this.isNewsletter()) {
      type.push("Newsletter");
    }
    if (this.isTransactional()) {
      type.push("Transactional");
    }
    return type;
  }

  isInvitation() {}
  hasAttachement() {}
  getSenderIp() {}
  extractPhoneContact() {}
  /**
   * It takes a metaDataProps object as an argument, and returns the value of the "date" property of that
   * object
   * @param metaDataProps - This is the metadata object that is passed to the function.
   * @returns The date of the article.
   */
  getDate() {
    return dateHelpers.parseDate(this.header?.date?.[0] ?? "");
  }
  /**
   * It returns an object with only the messaging fields from the header
   * @returns An object with only the messaging fields from the header.
   */
  getMessagingFieldsOnly() {
    const messagingProps = {};
    Object.keys(this.header).map((key) => {
      if (FIELDS.includes(key)) {
        messagingProps[key] = this.header[key][0];
      }
    });
    return messagingProps;
  }
  /**
   * It takes the header object and returns an object with all the properties that are not in the FIELDS
   * array
   * @returns An object with all the metadata fields that are not in the FIELDS array.
   */
  getOtherMetaDataFields() {
    const metaDataProps = {};
    Object.keys(this.header).map((key) => {
      if (!FIELDS.includes(key)) {
        metaDataProps[key] = this.header[key][0];
      }
    });
    return metaDataProps;
  }
  /**
   * It returns the message-id of the email
   * @returns The message-id of the email.
   */
  getMessageId() {
    if (this.header["message-id"]) {
      return this.header["message-id"][0];
    }
  }

  /**
   * It takes in an object of messaging fields and metadata properties, and returns an array of email
   * objects
   * @param messagingFields - an object with the keys being the messaging fields and the values being the
   * values of those fields.
   * @param metaDataProps - This is the metadata object that is passed to the function.
   * @returns An array of objects.
   */
  async getEmailsObjectsFromHeader(messagingFields) {
    let self = this;
    Object.keys(messagingFields).map(async (key) => {
      const emails = regExHelpers.extractNameAndEmail(messagingFields[key]);
      let message_id = this.getMessageId();
      if (emails) {
        emails.map(async (email) => {
          if (email) {
            if (
              email.address &amp;&amp;
              this.user.email != email.address &amp;&amp;
              dataStructureHelpers.IsNotNoReply(email.address) &amp;&amp;
              dataStructureHelpers.checkDomainIsOk(email.address)
            ) {
              emailsRaw.create({
                user_id: this.user.id,
                message_id: message_id,
                from: key == "from" ? true : false,
                reply_to: key == "reply-to" ? true : false,
                to: key == "to" ? true : false,
                cc: key == "cc" ? true : false,
                bcc: key == "bcc" ? true : false,
                date: this.getDate(),
                name: email?.name ?? "",
                address: email.address,
                newsletter: this.isNewsletter() ? true : false,
                transactional: this.isTransactional() ? true : false,
                conversation: this.isInConversation() == true ? 1 : 0,
              });
            }
          }
        });
      }
    });
  }
  /**
   * It takes the body of an email, extracts the email addresses from it, and returns an array of objects
   * that contain the email addresses and other information about the email
   * @returns An array of objects.
   */
  async getEmailsObjectsFromBody() {
    const emails = regExHelpers.extractNameAndEmailFromBody(
      this.body.toString("utf8")
    );
    let message_id = this.getMessageId();
    if (emails) {
      emails.map(async (email) => {
        if (
          email &amp;&amp;
          this.user.email != email &amp;&amp;
          dataStructureHelpers.IsNotNoReply(email) &amp;&amp;
          dataStructureHelpers.checkDomainIsOk(email)
        ) {
          emailsRaw.create({
            user_id: this.user.id,
            message_id: this.getMessageId(),
            from: false,
            reply_to: false,
            to: false,
            cc: false,
            bcc: false,
            body: true,
            date: this.getDate(),
            address: email,
            newsletter: this.isNewsletter() ? true : false,
            transactional: this.isTransactional() ? true : false,
            conversation: this.isInConversation() == true ? 1 : 0,
          });
        }
      });
    }
  }
  /**
   * It takes the header, extracts the messaging fields, extracts the other metadata fields, and then
   * returns an array of objects that contain the email addresses and the metadata fields
   * @returns An array of objects.
   */
  async extractEmailObjectsFromHeader() {
    const messagingFields = this.getMessagingFieldsOnly();
    const metaDataProps = this.getOtherMetaDataFields();
    const emailsObjects = await this.getEmailsObjectsFromHeader(
      messagingFields,
      metaDataProps
    );
    return emailsObjects;
  }
  /**
   * It takes the body of the email, converts it to a string, and then uses a regular expression to
   * extract all the email addresses from the body
   * @returns An array of objects.
   */
  async extractEmailObjectsFromBody() {
    if (Object.keys(this.body).length > 0) {
      await this.getEmailsObjectsFromBody();
    }
  }
}
module.exports = EmailMessage;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Wed Jul 06 2022 10:40:57 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
